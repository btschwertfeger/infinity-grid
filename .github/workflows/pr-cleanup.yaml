# -*- mode: yaml; coding: utf-8 -*-
#
# Copyright (C) 2025 Benjamin Thomas Schwertfeger
# All rights reserved.
# https://github.com/btschwertfeger
#
# Workflow to clean up Helm deployments when pull requests are closed
#

name: PR Cleanup

on:
  pull_request:
    types: [closed]
    branches: ["**"]

concurrency:
  group: cleanup-${{ github.head_ref }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write
  pull-requests: write

jobs:
  ## ===========================================================================
  ##    Clean up Helm deployment when PR is closed
  ##
  Cleanup-Deployment:
    if: |
      github.actor == 'btschwertfeger'
      && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit
          disable-sudo: false

      - name: Set up Kubernetes config
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
        run: |
          mkdir -p ~/.kube
          chmod go-rwx ~/.kube
          echo "$KUBECONFIG" > ~/.kube/config

      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
        with:
          version: "latest"

      - name: Generate release name
        id: release-name
        run: |
          # Use simple naming: infinity-grid-pr-{number}
          RELEASE_NAME="infinity-grid-pr-${{ github.event.number }}"
          echo "name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "Release name to cleanup: $RELEASE_NAME"

      - name: Check if release exists
        id: check-release
        run: |
          if helm list -n infinity-grid | grep -q "${{ steps.release-name.outputs.name }}"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release ${{ steps.release-name.outputs.name }} found in namespace infinity-grid"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release ${{ steps.release-name.outputs.name }} not found in namespace infinity-grid"
          fi

      - name: Uninstall Helm release
        if: steps.check-release.outputs.exists == 'true'
        run: |
          echo "Uninstalling Helm release: ${{ steps.release-name.outputs.name }}"
          helm uninstall "${{ steps.release-name.outputs.name }}" --namespace infinity-grid --timeout 5m

      - uses: dataaxiom/ghcr-cleanup-action@v1
        with:
          delete-tags: "pr-${{ github.event.number }}"

      - name: Comment on PR with cleanup status
        uses: actions/github-script@v8
        with:
          script: |
            const releaseName = '${{ steps.release-name.outputs.name }}';
            const releaseExists = '${{ steps.check-release.outputs.exists }}' === 'true';
            const prNumber = '${{ github.event.number }}';

            let comment;
            if (releaseExists) {
              comment = `## üßπ Cleanup Complete

              **Release Name:** \`${releaseName}\`
              **PR Number:** \`${prNumber}\`
              **Status:** ‚úÖ Successfully cleaned up

              The following resources have been cleaned up:
              - ‚úÖ Kubernetes deployment uninstalled
              - ‚úÖ PR-specific Docker image cleanup attempted (\`ghcr.io/${{ github.repository }}:pr-${prNumber}\`)

              The infrastructure for this PR has been fully cleaned up.`;
            } else {
              comment = `## üßπ Cleanup Status

              **Release Name:** \`${releaseName}\`
              **PR Number:** \`${prNumber}\`
              **Status:** ‚ÑπÔ∏è Partial cleanup

              The following actions were taken:
              - ‚ÑπÔ∏è No Kubernetes deployment found to clean up
              - ‚úÖ PR-specific Docker image cleanup attempted (\`ghcr.io/${{ github.repository }}:pr-${prNumber}\`)

              No active deployment was found for this branch.`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
